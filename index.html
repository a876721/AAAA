<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éæ´²å‹•ç‰©æ–¹å¡ŠéŠæˆ²</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3e8; /* æ·ºåœŸè‰²èƒŒæ™¯ */
        }
        .game-container {
            max-width: 500px;
            margin: 20px auto;
            background-color: #ffffff;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            border: 8px solid #8B4513; /* æ·±æ£•è‰²é‚Šæ¡† */
        }
        .game-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            aspect-ratio: 1 / 1; /* ä¿æŒæ­£æ–¹å½¢ */
            border: 2px solid #333;
            background-color: #008000; /* æ¨¡æ“¬è‰åœ° */
        }
        .gem {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            cursor: pointer;
            transition: transform 0.1s ease-out, opacity 0.3s ease-in-out;
            user-select: none;
            position: relative;
        }
        .selected {
            outline: 4px solid #FFD700; /* é»ƒé‡‘é‚Šæ¡† */
            outline-offset: -4px;
            z-index: 10;
        }
        .matching {
            animation: match-fade 0.5s forwards;
        }
        @keyframes match-fade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }
        .btn-primary {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 9999px;
            box-shadow: 0 4px #388E3C;
            transition: all 0.1s;
        }
        .btn-primary:active {
            box-shadow: 0 1px #388E3C;
            transform: translateY(3px);
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 640px) {
            .game-container {
                margin: 10px;
                width: calc(100% - 20px);
                max-width: 100%;
            }
            .gem {
                font-size: clamp(1.2rem, 6vw, 2rem);
            }
        }
    </style>
</head>
<body class="p-4">

    <div id="app" class="game-container rounded-xl p-4 flex flex-col items-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ˜ éæ´²å‹•ç‰©æ–¹å¡Š ğŸ¦</h1>
        
        <!-- æ–°å¢è¨ˆæ™‚å™¨å’Œåˆ†æ•¸é¡¯ç¤ºé¢æ¿ -->
        <div class="flex justify-between w-full mb-4 space-x-2">
            <p id="timer-display" class="flex-1 text-xl font-mono text-red-600 bg-red-100 p-2 rounded-lg text-center shadow-inner border border-red-300 transition-colors">
                æ™‚é–“: 40s
            </p>
            <p id="score-display" class="flex-1 text-xl font-mono text-green-700 bg-yellow-100 p-2 rounded-lg text-center shadow-inner border border-yellow-300">
                åˆ†æ•¸: 0
            </p>
        </div>

        <div id="game-grid" class="game-grid w-full rounded-lg">
            <!-- å‹•ç‰©æ–¹å¡Šå°‡ç”± JavaScript å¡«å…… -->
        </div>

        <!-- æ–°å¢æ’è¡Œæ¦œæŒ‰éˆ• -->
        <div class="flex w-full mt-6 space-x-4">
            <button id="new-game-btn" class="btn-primary flex-1 text-lg font-bold">
                é‡æ–°é–‹å§‹
            </button>
            <button id="leaderboard-btn" class="btn-primary bg-blue-500 hover:bg-blue-600 shadow-blue-700 flex-1 text-lg font-bold">
                æ’è¡Œæ¦œ ğŸ“
            </button>
        </div>

        <!-- éŠæˆ²è¨Šæ¯/æ¨¡æ…‹æ¡† (ç”¨æ–¼ä¸€èˆ¬è¨Šæ¯å’Œåˆ†æ•¸å„²å­˜) -->
        <div id="message-box" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-20">
            <div class="bg-white p-8 rounded-lg shadow-2xl max-w-sm w-full text-center">
                <h3 id="message-title" class="text-2xl font-bold mb-4 text-green-700"></h3>
                <p id="message-text" class="mb-6 text-gray-600"></p>
                
                <!-- æ–°å¢ï¼šç©å®¶åç¨±è¼¸å…¥æ¡† (é è¨­éš±è—) -->
                <input id="player-name-input" type="text" placeholder="è¼¸å…¥æ‚¨çš„åç¨± (æœ€å¤š8å­—å…ƒ)" maxlength="8" class="hidden w-full p-2 mb-4 border-2 border-gray-300 rounded-lg text-center font-bold text-gray-700 focus:outline-none focus:border-blue-500">

                <!-- è®Šæ›´ï¼šæŒ‰éˆ•å°‡æ ¹æ“šæƒ…å¢ƒèª¿æ•´æ–‡å­—å’Œè¡Œç‚º -->
                <button id="action-button" class="btn-primary w-full">
                    ç¢ºå®š
                </button>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œæ¨¡æ…‹æ¡† -->
        <div id="leaderboard-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center p-4 z-30">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all">
                <!-- æ¨™é¡Œå·²æ›´æ–°ç‚ºã€Œå…¨çƒæ’è¡Œæ¦œã€ -->
                <h3 class="text-3xl font-extrabold mb-6 text-center text-blue-700">ğŸ† å…¨çƒæ’è¡Œæ¦œ ğŸ†</h3>
                <!-- ç§»é™¤äº†é¡¯ç¤ºç”¨æˆ¶ ID çš„å…ƒç´  -->
                <p class="text-sm text-center text-gray-500 mb-4">æ­¤ç‚ºæ‰€æœ‰ç©å®¶å…±äº«çš„å…¬é–‹ç´€éŒ„ã€‚</p>
                <div id="leaderboard-list" class="space-y-3">
                    <!-- æ’è¡Œæ¦œå…§å®¹å°‡ç”± JS å¡«å…… -->
                    <p class="text-center text-gray-500">è¼‰å…¥ä¸­...</p>
                </div>
                <button id="close-leaderboard-btn" class="btn-primary mt-6 w-full bg-red-500 shadow-red-700">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <!-- æ¨¡çµ„åŒ– JavaScript - Firebase è¨­ç½®å’ŒéŠæˆ²é‚è¼¯ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            orderBy, 
            limit, 
            addDoc, 
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ======================================================================
        // [å·²æ›´æ–°] é€™æ˜¯æ‚¨çš„ Firebase å°ˆæ¡ˆé…ç½® 'rabbits-638bc' çš„å¯¦éš›å¯†é‘°ã€‚
        // ======================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyChWzeo7yP_eebJRqBwRRu6tZdbUfrGRsI", 
            authDomain: "rabbits-638bc.firebaseapp.com",
            projectId: "rabbits-638bc", 
            storageBucket: "rabbits-638bc.firebasestorage.app",
            messagingSenderId: "668839331574",
            appId: "1:668839331574:web:fc28cd1a33effb92f74ed7"
        };

        // å›ºå®š App ID åƒ…ç”¨æ–¼çµ„ç¹”å…¬é–‹æ’è¡Œæ¦œè³‡æ–™ã€‚
        const fixedAppId = 'safari-match-3';
        // ======================================================================

        let app;
        let db;
        let auth;
        let userId = 'anon_user'; // é è¨­å€¼
        let isAuthReady = false; // è¿½è¹¤èªè­‰æ˜¯å¦å®Œæˆ

        // åˆå§‹åŒ– Firebase (ä½¿ç”¨æ‚¨æä¾›çš„å¯†é‘°)
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // [ä¿®æ­£] ä½¿ç”¨æ¨™æº–çš„åŒ¿åç™»å…¥
        async function initializeAuth() {
            try {
                // å˜—è©¦åŒ¿åç™»å…¥
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase åŒ¿åèªè­‰æˆåŠŸ, ç”¨æˆ¶ID:", userId);
                    } else {
                        // å¦‚æœåŒ¿åç™»å…¥å¤±æ•—ï¼Œä½¿ç”¨éš¨æ©Ÿ ID ä½œç‚ºå‚™ç”¨
                        userId = crypto.randomUUID();
                        console.log("Firebase åŒ¿åèªè­‰å¤±æ•—ï¼Œä½¿ç”¨éš¨æ©Ÿ ID:", userId);
                    }
                    isAuthReady = true;
                    // èªè­‰å®Œæˆå¾Œå•Ÿå‹•æ’è¡Œæ¦œç›£è½
                    fetchLeaderboard();
                });

            } catch (error) {
                console.error("Firebase èªè­‰å¤±æ•—:", error);
                isAuthReady = true; // å³ä½¿å¤±æ•—ä¹Ÿæ¨™è¨˜ç‚ºå®Œæˆï¼Œé˜²æ­¢é˜»å¡
                userId = crypto.randomUUID();
            }
        }
        initializeAuth();


        // --- éŠæˆ²é‚è¼¯é–‹å§‹ ---
        const GRID_SIZE = 8;
        const ANIMALS = ['ğŸ¦', 'ğŸ˜', 'ğŸ¦“', 'ğŸ¦’', 'ğŸ¦›', 'ğŸ†']; // ç…å­, å¤§è±¡, æ–‘é¦¬, é•·é ¸é¹¿, æ²³é¦¬, çµè±¹
        const GAME_DURATION = 40; // 40ç§’
        
        const animalGrid = [];
        let score = 0;
        let selectedGem = null;
        let isProcessing = false;
        let timeLeft = GAME_DURATION;
        let timerInterval = null;
        let isGameOver = false;

        // DOM å…ƒç´ å¼•ç”¨
        const gridElement = document.getElementById('game-grid');
        const scoreDisplay = document.getElementById('score-display');
        const timerDisplay = document.getElementById('timer-display');
        const newGameBtn = document.getElementById('new-game-btn');
        const messageBox = document.getElementById('message-box');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const playerNameInput = document.getElementById('player-name-input'); // ç©å®¶åç¨±è¼¸å…¥æ¡†
        const actionButton = document.getElementById('action-button'); 

        const leaderboardBtn = document.getElementById('leaderboard-btn');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const leaderboardList = document.getElementById('leaderboard-list');
        const closeLeaderboardBtn = document.getElementById('close-leaderboard-btn');


        /**
         * é¡¯ç¤ºè‡ªå®šç¾©è¨Šæ¯æ¡†
         * @param {string} title è¨Šæ¯æ¨™é¡Œ
         * @param {string} text è¨Šæ¯å…§å®¹
         * @param {function(string | null)} action æŒ‰éˆ•é»æ“Šå¾ŒåŸ·è¡Œçš„å‹•ä½œï¼Œå¦‚æœ showInput=trueï¼Œæœƒå‚³å…¥è¼¸å…¥å€¼
         * @param {string} buttonText æŒ‰éˆ•æ–‡å­—
         * @param {boolean} showInput æ˜¯å¦é¡¯ç¤ºè¼¸å…¥æ¡†
         */
        function showModal(title, text, action, buttonText = 'ç¢ºå®š', showInput = false) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            actionButton.textContent = buttonText;
            
            // è™•ç†è¼¸å…¥æ¡†é¡¯ç¤º
            playerNameInput.classList.toggle('hidden', !showInput);
            if (showInput) {
                playerNameInput.value = ''; 
                playerNameInput.placeholder = "è¼¸å…¥æ‚¨çš„åç¨± (æœ€å¤š8å­—å…ƒ)"; 
                playerNameInput.focus();
            }

            // æ¸…é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼Œä¸¦è¨­ç½®æ–°çš„
            actionButton.onclick = null; 
            actionButton.onclick = () => {
                let inputValue = null;
                if (showInput) {
                    // é—œéµä¿®æ­£ï¼šå…ˆæ•ç²è¼¸å…¥å€¼ï¼Œå†åŸ·è¡Œå‹•ä½œ
                    inputValue = playerNameInput.value.trim(); 
                }
                
                // åŸ·è¡Œå‹•ä½œï¼Œä¸¦å‚³å…¥æ•ç²åˆ°çš„å€¼
                if (action) action(inputValue); 

                // å‹•ä½œåŸ·è¡Œå®Œç•¢å¾Œï¼Œå†é—œé–‰æ¨¡æ…‹æ¡†
                closeModal();
            };

            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        /**
         * é—œé–‰è‡ªå®šç¾©è¨Šæ¯æ¡†
         */
        function closeModal() {
            messageBox.classList.add('hidden');
            messageBox.classList.remove('flex');
        }

        // ç¶å®šæ’è¡Œæ¦œæŒ‰éˆ•
        leaderboardBtn.addEventListener('click', () => {
            leaderboardModal.classList.remove('hidden');
            leaderboardModal.classList.add('flex');
        });
        closeLeaderboardBtn.addEventListener('click', () => {
            leaderboardModal.classList.add('hidden');
            leaderboardModal.classList.remove('flex');
        });

        /**
         * éš¨æ©Ÿé¸æ“‡ä¸€ç¨®å‹•ç‰©
         * @returns {string} å‹•ç‰©è¡¨æƒ…ç¬¦è™Ÿ
         */
        function getRandomAnimal() {
            return ANIMALS[Math.floor(Math.random() * ANIMALS.length)];
        }

        /**
         * æª¢æŸ¥çµ¦å®šåº§æ¨™æ˜¯å¦æœ‰åŒ¹é… (ç”¨æ–¼åˆå§‹åŒ–æ™‚é¿å…åˆå§‹åŒ¹é…)
         * @param {number} r è¡Œ
         * @param {number} c åˆ—
         * @param {string} animal è¦æª¢æŸ¥çš„å‹•ç‰©é¡å‹
         * @returns {boolean} æ˜¯å¦å­˜åœ¨åŒ¹é…
         */
        function hasMatchAt(r, c, animal) {
            // æª¢æŸ¥æ°´å¹³å·¦å´å…©å€‹
            if (c >= 2 && animalGrid[r][c - 1] === animal && animalGrid[r][c - 2] === animal) return true;
            // æª¢æŸ¥å‚ç›´ä¸Šæ–¹å…©å€‹
            if (r >= 2 && animalGrid[r - 1][c] === animal && animalGrid[r - 2][c] === animal) return true;
            return false;
        }

        /**
         * åˆå§‹åŒ–éŠæˆ²ç¶²æ ¼
         */
        function initializeGrid() {
            for (let r = 0; r < GRID_SIZE; r++) {
                animalGrid[r] = [];
                for (let c = 0; c < GRID_SIZE; c++) {
                    let animal;
                    // ç”Ÿæˆå‹•ç‰©ï¼Œé¿å…åˆå§‹åŒ¹é…
                    do {
                        animal = getRandomAnimal();
                    } while (hasMatchAt(r, c, animal));
                    animalGrid[r][c] = animal;
                }
            }
        }

        /**
         * æ¸²æŸ“ç¶²æ ¼åˆ° HTML
         */
        function renderGrid() {
            gridElement.innerHTML = '';
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    const gem = document.createElement('div');
                    gem.classList.add('gem');
                    gem.dataset.row = r;
                    gem.dataset.col = c;
                    gem.textContent = animalGrid[r][c];
                    gem.addEventListener('click', handleGemClick);
                    gridElement.appendChild(gem);
                }
            }
        }

        /**
         * æ–°å¢åˆ†æ•¸åˆ°ç¸½åˆ†
         */
        function addPoints(points) {
            score += points;
            scoreDisplay.textContent = `åˆ†æ•¸: ${score}`;
        }
        
        /**
         * é‡è¨­åˆ†æ•¸ä¸¦æ›´æ–°é¡¯ç¤º
         */
        function resetScore() {
            score = 0;
            scoreDisplay.textContent = `åˆ†æ•¸: 0`;
        }

        /**
         * è™•ç†æ–¹å¡Šé»æ“Šäº‹ä»¶
         */
        function handleGemClick(e) {
            if (isProcessing || isGameOver) return; 

            const clickedGem = e.currentTarget;
            const r = parseInt(clickedGem.dataset.row);
            const c = parseInt(clickedGem.dataset.col);

            if (selectedGem) {
                document.querySelector(`[data-row="${selectedGem.r}"][data-col="${selectedGem.c}"]`)?.classList.remove('selected');
            }

            if (!selectedGem) {
                selectedGem = { r, c, element: clickedGem };
                clickedGem.classList.add('selected');
            } else if (selectedGem.r === r && selectedGem.c === c) {
                selectedGem = null;
            } else if (isAdjacent(selectedGem.r, selectedGem.c, r, c)) {
                isProcessing = true;
                performSwap(selectedGem, { r, c, element: clickedGem });
                selectedGem = null; 
            } else {
                selectedGem = { r, c, element: clickedGem };
                clickedGem.classList.add('selected');
            }
        }

        /**
         * æª¢æŸ¥å…©çµ„åº§æ¨™æ˜¯å¦é„°è¿‘
         */
        function isAdjacent(r1, c1, r2, c2) {
            return Math.abs(r1 - r2) + Math.abs(c1 - c2) === 1;
        }

        /**
         * åŸ·è¡Œäº¤æ›ä¸¦æª¢æŸ¥åŒ¹é…
         */
        async function performSwap(gem1, gem2) {
            const element1 = document.querySelector(`[data-row="${gem1.r}"][data-col="${gem1.c}"]`);
            const element2 = document.querySelector(`[data-row="${gem2.r}"][data-col="${gem2.c}"]`);
            
            [animalGrid[gem1.r][gem1.c], animalGrid[gem2.r][gem2.c]] = [animalGrid[gem2.r][gem2.c], animalGrid[gem1.r][gem1.c]];

            element1.textContent = animalGrid[gem1.r][gem1.c];
            element2.textContent = animalGrid[gem2.r][gem2.c];

            await new Promise(resolve => setTimeout(resolve, 50)); 

            const matches = findMatches();

            if (matches.length > 0) {
                await processMatches(matches);
                while (true) {
                    await applyGravity();
                    renderGrid(); 
                    const nextMatches = findMatches();
                    if (nextMatches.length === 0) break;
                    await processMatches(nextMatches);
                }
            } else {
                [animalGrid[gem1.r][gem1.c], animalGrid[gem2.r][gem2.c]] = [animalGrid[gem2.r][gem2.c], animalGrid[gem1.r][gem1.c]];
                element1.textContent = animalGrid[gem1.r][gem1.c];
                element2.textContent = animalGrid[gem2.r][gem2.c];
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            if (!isGameOver && findPossibleMoves().length === 0) {
                gameOver(true); 
            }

            isProcessing = false;
            document.querySelectorAll('.selected').forEach(g => g.classList.remove('selected'));
        }

        /**
         * å°‹æ‰¾æ‰€æœ‰ 3 å€‹æˆ–æ›´å¤šé€£ç·šçš„åŒ¹é…
         */
        function findMatches() {
            const matches = new Set();
            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE - 2; c++) {
                    const animal = animalGrid[r][c];
                    if (animal && animalGrid[r][c + 1] === animal && animalGrid[r][c + 2] === animal) {
                        let i = c;
                        while (i < GRID_SIZE && animalGrid[r][i] === animal) {
                            matches.add(`${r},${i}`);
                            i++;
                        }
                    }
                }
            }
            for (let c = 0; c < GRID_SIZE; c++) {
                for (let r = 0; r < GRID_SIZE - 2; r++) {
                    const animal = animalGrid[r][c];
                    if (animal && animalGrid[r + 1][c] === animal && animalGrid[r + 2][c] === animal) {
                        let i = r;
                        while (i < GRID_SIZE && animalGrid[i][c] === animal) {
                            matches.add(`${i},${c}`);
                            i++;
                        }
                    }
                }
            }
            return Array.from(matches).map(str => {
                const parts = str.split(',');
                return { r: parseInt(parts[0]), c: parseInt(parts[1]) };
            });
        }

        /**
         * è™•ç†åŒ¹é…ï¼šæ¸…é™¤æ–¹å¡Šï¼Œæ›´æ–°åˆ†æ•¸
         */
        async function processMatches(matches) {
            const points = matches.length * 10;
            addPoints(points); 

            matches.forEach(({ r, c }) => {
                const gemElement = document.querySelector(`[data-row="${r}"][data-col="${c}"]`);
                if (gemElement) {
                    gemElement.classList.add('matching');
                }
            });

            await new Promise(resolve => setTimeout(resolve, 500));

            matches.forEach(({ r, c }) => {
                animalGrid[r][c] = null; 
            });
        }

        /**
         * å¯¦æ–½é‡åŠ›ï¼šè®“æ–¹å¡Šæ‰è½
         */
        async function applyGravity() {
            for (let c = 0; c < GRID_SIZE; c++) {
                let emptyRow = GRID_SIZE - 1; 
                for (let r = GRID_SIZE - 1; r >= 0; r--) {
                    if (animalGrid[r][c] !== null) {
                        if (r !== emptyRow) {
                            animalGrid[emptyRow][c] = animalGrid[r][c];
                            animalGrid[r][c] = null;
                        }
                        emptyRow--;
                    }
                }
                for (let r = 0; r <= emptyRow; r++) {
                    animalGrid[r][c] = getRandomAnimal();
                }
            }
            await new Promise(resolve => setTimeout(resolve, 100)); 
        }

        /**
         * å°‹æ‰¾æ‰€æœ‰å¯èƒ½çš„åˆæ³•äº¤æ›ç§»å‹•
         */
        function findPossibleMoves() {
            const moves = [];
            function checkSwap(r1, c1, r2, c2) {
                [animalGrid[r1][c1], animalGrid[r2][c2]] = [animalGrid[r2][c2], animalGrid[r1][c1]];
                const matches = findMatches();
                [animalGrid[r1][c1], animalGrid[r2][c2]] = [animalGrid[r2][c2], animalGrid[r1][c1]];
                return matches.length > 0;
            }

            for (let r = 0; r < GRID_SIZE; r++) {
                for (let c = 0; c < GRID_SIZE; c++) {
                    if (c + 1 < GRID_SIZE && checkSwap(r, c, r, c + 1)) {
                        moves.push({ from: { r, c }, to: { r, c: c + 1 } });
                    }
                    if (r + 1 < GRID_SIZE && checkSwap(r, c, r + 1, c)) {
                        moves.push({ from: { r, c }, to: { r: r + 1, c } });
                    }
                }
            }
            return moves;
        }

        // --- è¨ˆæ™‚å™¨é‚è¼¯ ---

        /**
         * é–‹å§‹å€’æ•¸è¨ˆæ™‚å™¨
         */
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timeLeft = GAME_DURATION;
            isGameOver = false;
            timerDisplay.textContent = `æ™‚é–“: ${timeLeft}s`;
            timerDisplay.classList.remove('bg-red-500', 'text-white'); 

            timerInterval = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `æ™‚é–“: ${timeLeft}s`;

                if (timeLeft <= 5) {
                    timerDisplay.classList.add('bg-red-500', 'text-white');
                }

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    timerDisplay.textContent = `æ™‚é–“: 0s`;
                    gameOver(false); 
                }
            }, 1000);
        }

        /**
         * éŠæˆ²çµæŸæµç¨‹
         */
        function gameOver(noMoreMoves) {
            if (isGameOver) return;
            isProcessing = true;
            isGameOver = true;
            if (timerInterval) clearInterval(timerInterval);
            timerDisplay.classList.remove('bg-red-500', 'text-white'); 
            
            showScoreSaveModal(score, noMoreMoves);
        }

        /**
         * é¡¯ç¤ºåˆ†æ•¸å„²å­˜æ¨¡æ…‹æ¡†ï¼Œè®“ç”¨æˆ¶è¼¸å…¥åç¨±
         */
        function showScoreSaveModal(finalScore, noMoreMoves) {
            let title = noMoreMoves ? 'æ²’æœ‰å¯ç§»å‹•çš„æ­¥é©Ÿäº†ï¼' : 'æ™‚é–“åˆ°ï¼éŠæˆ²çµæŸï¼';
            let text = `ä½ åœ¨å›åˆä¸­ç²å¾—äº† ${finalScore} åˆ†ï¼è«‹è¼¸å…¥åç¨±ä»¥å„²å­˜åˆ†æ•¸ã€‚`;
            
            // å„²å­˜å‹•ä½œ (æ¥æ”¶å¾ showModal æ•ç²çš„åç¨±)
            const saveAction = (inputValue) => {
                let playerName = inputValue; 
                
                if (playerName === '' || playerName === null) {
                    playerName = 'åŒ¿åç©å®¶'; 
                }
                
                // å„²å­˜é«˜åˆ†
                saveHighScore(finalScore, playerName);
                
                playerNameInput.value = '';
            };

            showModal(title, text, saveAction, 'å„²å­˜åˆ†æ•¸ä¸¦æŸ¥çœ‹ç´€éŒ„', true);
            
            playerNameInput.placeholder = `è¼¸å…¥æ‚¨çš„åç¨± (é è¨­: åŒ¿åç©å®¶)`;
        }


        // --- æ’è¡Œæ¦œ (Firestore) é‚è¼¯ ---

        /**
         * å„²å­˜é«˜åˆ†åˆ° Firestore (ä½¿ç”¨å…¬é–‹è·¯å¾‘)
         */
        async function saveHighScore(finalScore, displayName) {
            if (!db || finalScore <= 0 || !isAuthReady) return; // ç¢ºä¿ DB åˆå§‹åŒ–ä¸”èªè­‰å®Œæˆ

            const scoreData = {
                score: finalScore,
                timestamp: new Date(),
                displayName: displayName
            };

            try {
                // ä½¿ç”¨å›ºå®šçš„ 'leaderboard_public_collection' ä½œç‚ºå…¬é–‹æ’è¡Œæ¦œåç¨±
                const leaderboardRef = collection(db, 'leaderboard_public_collection');
                
                for (let i = 0; i < 3; i++) {
                    try {
                        await addDoc(leaderboardRef, scoreData);
                        console.log(`é«˜åˆ†å·²å„²å­˜: ${finalScore} (ç©å®¶: ${displayName})`);
                        
                        showModal('å„²å­˜æˆåŠŸï¼', `æ‚¨çš„åˆ†æ•¸ ${finalScore} å·²æˆåŠŸè¨˜éŒ„åˆ°å…¨çƒæ’è¡Œæ¦œï¼`, () => {
                            leaderboardModal.classList.remove('hidden');
                            leaderboardModal.classList.add('flex');
                        }, 'æŸ¥çœ‹æ’è¡Œæ¦œ');

                        return; 
                    } catch (e) {
                        if (i === 2) throw e; 
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); 
                    }
                }
            } catch (e) {
                console.error("å„²å­˜é«˜åˆ†æ™‚ç™¼ç”ŸéŒ¯èª¤:", e);
                showModal('éŒ¯èª¤', 'å„²å­˜åˆ†æ•¸æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚', null);
            }
        }

        /**
         * å¾ Firestore ç›£è½ä¸¦ç²å–æ’è¡Œæ¦œ (ä½¿ç”¨å…¬é–‹è·¯å¾‘)
         */
        function fetchLeaderboard() {
            if (!db || !isAuthReady) {
                leaderboardList.innerHTML = '<p class="text-center text-red-500">ç„¡æ³•é€£æ¥è³‡æ–™åº«ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ Firebase é…ç½®ã€‚</p>';
                return;
            }
            
            // ä½¿ç”¨å›ºå®šçš„ 'leaderboard_public_collection'
            const leaderboardRef = collection(db, 'leaderboard_public_collection');
            
            const q = query(leaderboardRef, orderBy("score", "desc"), limit(10));

            // å¯¦æ™‚ç›£è½
            onSnapshot(q, (snapshot) => {
                const scores = [];
                snapshot.forEach((doc) => {
                    scores.push(doc.data());
                });
                renderLeaderboard(scores);
            }, (error) => {
                console.error("è®€å–æ’è¡Œæ¦œæ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                leaderboardList.innerHTML = '<p class="text-center text-red-500">è®€å–å…¨çƒæ’è¡Œæ¦œå¤±æ•—ã€‚</p>';
            });
        }

        /**
         * æ¸²æŸ“æ’è¡Œæ¦œåˆ—è¡¨
         */
        function renderLeaderboard(scores) {
            if (scores.length === 0) {
                leaderboardList.innerHTML = '<p class="text-center text-gray-500">ç›®å‰æ²’æœ‰å…¬é–‹åˆ†æ•¸ç´€éŒ„ã€‚</p>';
                return;
            }

            leaderboardList.innerHTML = scores.map((data, index) => {
                const rank = index + 1;
                let color = 'text-gray-700';
                let icon = `${rank}.`;
                const displayScore = data.score || 0; 

                let border = 'border-l-4 border-gray-300';
                if (rank === 1) {
                    color = 'text-yellow-600 font-extrabold bg-yellow-50';
                    icon = 'ğŸ¥‡';
                    border = 'border-l-4 border-yellow-500';
                } else if (rank === 2) {
                    color = 'text-gray-600 font-bold bg-gray-50';
                    icon = 'ğŸ¥ˆ';
                    border = 'border-l-4 border-gray-400';
                } else if (rank === 3) {
                    color = 'text-amber-600 font-semibold bg-amber-50';
                    icon = 'ğŸ¥‰';
                    border = 'border-l-4 border-amber-300';
                }
                
                const displayPlayerName = data.displayName?.trim() || 'åŒ¿åç©å®¶';

                return `
                    <div class="flex justify-between items-center p-3 rounded-lg ${border} ${color} shadow-sm">
                        <span class="text-lg flex items-center">
                            <span class="mr-2 font-bold">${icon}</span> <strong class="truncate max-w-xs">${displayPlayerName}</strong>
                        </span>
                        <span class="text-xl font-mono">${displayScore} åˆ†</span>
                    </div>
                `;
            }).join('');
        }

        /**
         * å•Ÿå‹•æ–°éŠæˆ²
         */
        function startNewGame() {
            resetScore();
            selectedGem = null;
            isProcessing = false;
            isGameOver = false;
            initializeGrid();
            renderGrid();
            startTimer(); 
            showModal('æ­¡è¿ï¼', `éŠæˆ²æ™‚é•· ${GAME_DURATION} ç§’ï¼å¿«é€Ÿäº¤æ›å‹•ç‰©ä»¥ç²å¾—é«˜åˆ†ï¼`, null);
            console.log('éŠæˆ²å·²é‡æ–°é–‹å§‹');
        }

        // ç¶å®šé‡æ–°é–‹å§‹æŒ‰éˆ•
        newGameBtn.addEventListener('click', startNewGame);

        // é¦–æ¬¡å•Ÿå‹•éŠæˆ²
        startNewGame();
    </script>
</body>
</html>